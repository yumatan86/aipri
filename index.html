<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QRまとめ生成（縦一列＋隙間あり）</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body { font-family: sans-serif; margin: 10px; text-align: center; }
  #reader { width: 100%; max-width: 320px; margin: auto; }
  #qr-list { list-style: none; padding: 0; margin: 10px 0; }
  #qr-list li { margin: 5px 0; word-break: break-all; font-size: 14px; }
  #output { border:1px solid #ccc; width: 90%; max-width: 320px; margin: 10px auto; }
  button { padding: 10px 20px; margin: 5px; font-size: 16px; }
</style>
</head>
<body>

<h2>QRまとめ生成（縦一列＋隙間あり）</h2>

<div id="reader"></div>
<button id="start-scan">QR読み取り開始</button>

<ul id="qr-list"></ul>

<canvas id="output" width="320" height="320"></canvas>
<br>
<button id="download">まとめ画像をダウンロード</button>

<script>
const qrData = [];
const maxQR = 4;
const qrCanvases = [];
const gap = 20; // QRコード間の隙間(px)

document.getElementById("start-scan").addEventListener("click", () => {
    const html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            if(qrData.length < maxQR && !qrData.includes(decodedText)){
                qrData.push(decodedText);
                const li = document.createElement("li");
                li.textContent = decodedText;
                document.getElementById("qr-list").appendChild(li);
                generateQRCanvas(decodedText, qrData.length-1);
            }
        },
        (errorMessage) => { /* 読み取り失敗は無視 */ }
    );
});

function generateQRCanvas(text, index){
    const canvas = document.createElement("canvas");
    canvas.width = 300;
    canvas.height = 300;
    QRCode.toCanvas(canvas, text, { width:300, margin:0 }, function (error) {
        if(error) console.error(error);
        qrCanvases[index] = canvas;
        updateOutput();
    });
}

function updateOutput(){
    const out = document.getElementById("output");
    const ctx = out.getContext("2d");
    
    const qrCount = qrCanvases.filter(c=>c).length;
    // 縦一列 + 隙間込みで高さ計算
    out.height = qrCount * 300 + (qrCount-1) * gap;

    ctx.clearRect(0,0,out.width,out.height);

    qrCanvases.forEach((c, i) => {
        if(!c) return;
        const y = i * (300 + gap);
        ctx.drawImage(c, 0, y, 320, 300);
    });
}

document.getElementById("download").addEventListener("click", () => {
    const out = document.getElementById("output");
    const link = document.createElement("a");
    link.href = out.toDataURL("image/png");
    link.download = "qrまとめ.png";
    link.click();
});
</script>

</body>
</html>
